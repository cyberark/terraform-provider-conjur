
function main() {
  echo ">> build image"
  dockerCompose build

  dockerCompose up -d terraform

  echo ">> Testing provider with tf-included vars"

  declare -a test_results=()

  # Run CRUD tests for each resource and collect results

  echo ">> Running Authenticator CRUD test"
  test_resource_crud "tests/resources/authenticator" "authenticator" "name"
  test_results+=("Authenticator|$?")

  # Stop the container
  dockerCompose down

  # Report results and set exit code
  report_test_results "${test_results[@]}"
  exit $?
}

function dockerCompose() {
  docker compose $DOCKER_COMPOSE_ARGS "$@"
}

function terraformExecute() {
  dockerCompose exec -T terraform sh -ec "$@"
}

function test_resource_crud() {
  local test_dir="$1"
  local resource_name="$2"
  local id_output_name="$3" # Output variable name for the resource ID

  echo "Testing ${resource_name} CRUD operations"

  # Cleanup any previous state
  cleanup_terraform "$test_dir"

  # Step 1: Create Resources
  echo "Step 1: Creating ${resource_name}"
  if ! terraformExecute "cd $test_dir/create && \
    terraform init && \
    terraform validate && \
    terraform plan && \
    terraform apply -auto-approve"; then
    echo "FAILED: ${resource_name} creation failed"
    return 1
  fi

  # Get the resource ID for validation (all fields)
  local resource_id_all_fields=$(terraformExecute "cd $test_dir/create && jq -r '.outputs.${resource_name}_${id_output_name}_all_fields.value' terraform.tfstate")
  if [[ -z "$resource_id_all_fields" || "$resource_id_all_fields" == "null" ]]; then
    echo "FAILED: Could not get $id_output_name from terraform output"
    return 1
  fi
  echo "Created ${resource_name} with ID: $resource_id_all_fields"

  # Get the resource ID for validation (required_only)
  local resource_id_required_only=$(terraformExecute "cd $test_dir/create && jq -r '.outputs.${resource_name}_${id_output_name}_required_only.value' terraform.tfstate")
  if [[ -z "$resource_id_required_only" || "$resource_id_required_only" == "null" ]]; then
    echo "FAILED: Could not get $id_output_name from terraform output"
    return 1
  fi
  echo "Created ${resource_name} with ID: $resource_id_required_only"

  # Step 2: Import the Resource
  echo "Step 2: Importing ${resource_name}"
  if ! terraformExecute "cd $test_dir/update && \
    terraform init && \
    terraform import conjur_${resource_name}.imported_all_fields jwt:${resource_id_all_fields}"; then
    echo "FAILED: ${resource_name} import command failed"
    return 1
  fi

  echo "Step 2: Importing ${resource_name}"
  if ! terraformExecute "cd $test_dir/update && \
    terraform init && \
    terraform import conjur_${resource_name}.imported_required_only jwt:${resource_id_required_only}"; then
    echo "FAILED: ${resource_name} import command failed"
    return 1
  fi

  echo "Verifying import of ${resource_name}"
  local import_ids=$(terraformExecute "cd $test_dir/update && jq -r '.resources[] | select(.type == \"conjur_${resource_name}\") | .instances[0].attributes.name' terraform.tfstate")
  local expected_ids=("$resource_id_all_fields" "$resource_id_required_only")
  for expected in "${expected_ids[@]}"; do
    if ! grep -qx "$expected" <<< "$import_ids"; then
      echo "FAILED: ${resource_name} import verification failed (missing $expected)"
      return 1
    fi
  done

  echo "${resource_name} import successful"

  # Step 3: Update the Resource
  if ! terraformExecute "cd $test_dir/update && \
    terraform validate && \
    terraform plan && \
    terraform apply -auto-approve"; then
    echo "FAILED: ${resource_name} update command failed"
    return 1
  fi

  # Verify update was successful
  local update_status_all_fields=$(terraformExecute "cd $test_dir/update && jq -r '.outputs.update_status_all_fields.value // \"fail\"' terraform.tfstate")
  local update_status_required_only=$(terraformExecute "cd $test_dir/update && jq -r '.outputs.update_status_required_only.value // \"fail\"' terraform.tfstate")
  if [[ "$update_status_all_fields" != "success" ]] || [[ "$update_status_required_only" != "success" ]]; then
    echo "FAILED: ${resource_name} update verification failed with status: $update_status"
    return 1
  fi

  # Step 4: Delete the Resource
  echo "Step 4: Deleting ${resource_name}"
  if ! terraformExecute "cd $test_dir/update && terraform destroy -auto-approve"; then
    echo "FAILED: ${resource_name} deletion failed"
    return 1
  fi

  echo "SUCCESS: ${resource_name} CRUD testing completed successfully"
  return 0
}

function cleanup_terraform() {
  local test_dir="$1"
  terraformExecute "cd $test_dir/create && rm -rf .terraform* terraform.tfstate*"
  terraformExecute "cd $test_dir/update && rm -rf .terraform* terraform.tfstate*"
}

function report_test_results() {
  echo "=========================================="
  echo "      RESOURCE TEST RESULTS SUMMARY       "
  echo "=========================================="

  local results=("$@")
  local total_tests=${#results[@]}
  local passed_tests=0
  local failed_tests=0

  # Print each test result
  for result in "${results[@]}"; do
    IFS='|' read -r name status <<< "$result"
    if [[ "$status" -eq 0 ]]; then
      echo "✅ $name: PASSED"
      passed_tests=$((passed_tests+1))
    else
      echo "❌ $name: FAILED"
      failed_tests=$((failed_tests+1))
    fi
  done

  echo "=========================================="
  echo "SUMMARY: $passed_tests of $total_tests resource tests passed, $failed_tests failed"
  echo "=========================================="

  if [[ "$passed_tests" -eq "$total_tests" ]]; then
    return 0
  else
    return 1
  fi
}

main