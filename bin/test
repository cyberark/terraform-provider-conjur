#!/bin/bash
set -exo pipefail

# Default values
TARGET=""
TEST_CASE=""
JWT_SETUP="false"
SHOW_HELP="false"

export CONJUR_PLUGIN_VERSION="$(cut -d'-' -f1 < VERSION)"
# Set a dummy version for local builds (must satisfy constraint '~> 0')
export CONJUR_PLUGIN_VERSION="${CONJUR_PLUGIN_VERSION:-0.0.1}"
export CONJUR_DATA_KEY='iFra75qdvsLENSV+qXYFMkv7KJS3t+82Po4mmjZLxZc='
export REGISTRY_URL="${INFRAPOOL_REGISTRY_URL:-docker.io}"
export TEST_SECRET_VAL="SECRETXcLhn23MJcimV"
export CONJUR_ACCOUNT='conjur'
CONJUR_AUTHN_PASSWORD='SEcret12!!!!'
LOCAL_SECRET_FILE='tests/dbpass'
api_key=""
ssl_cert=""
JWT_TOKEN=""
GCP_TOKEN=""

source "$(git rev-parse --show-toplevel)/bin/utils.sh"

# Function to teardown
function clean() {
  if [[ "$JWT_SETUP" == "true" ]]; then
    echo "> Skipping cleanup as JWT_SETUP is true. Stashing token in the file: jwt_token"
    echo $JWT_TOKEN > jwt_token
    return 0
  fi

  case "$TARGET" in
  "oss"|"enterprise" )
  if [[ -z "$KEEP_CONTAINERS" ]]; then
    echo "> Terminating local Conjur environment"

    docker_compose logs

    rm -f $LOCAL_SECRET_FILE
    docker_compose down -v
  else
    echo "> KEEP_CONTAINERS is set, not terminating local Conjur environment"
  fi
  ;;
  esac
}

trap clean EXIT

function main() {
  clean
  docker_compose build
  replace_templates
  check_target

  case "$TARGET" in
    "oss" | "enterprise")
      export CONJUR_APPLIANCE_URL=https://conjur-server
      deploy_conjur
      configure_cli
      ;;
    "cloud")
      export CONJUR_APPLIANCE_URL="$INFRAPOOL_CONJUR_APPLIANCE_URL/api"
      export CONJUR_SSL_CERTIFICATE=$(cat conf/cloud_ca.pem)
      ;;
    *)
      echo "> Error: '$TARGET' is not a supported target"
      exit 1
      ;;
  esac

  load_test_policies

  [[ "$JWT_SETUP" == "true" ]] && exit 0 # This condition is needed for the codecoverage script to succeed (reasons unknown)

  echo ">> Running tests for target: $TARGET with test case: $TEST_CASE"
  overall_status=0

  setup_test_dir
  echo "Running test from directory: $test_dir"
  set_TF_vars
  # test -f "$test_dir/env" && source "$test_dir/env"
  run_terraform_tests "$test_dir" || overall_status=1
  validate_results || overall_status=1

  if [[ "$run_resource_tests" == "true" ]]; then
    TARGET=$TARGET ./bin/run_resource_tests || overall_status=1
  fi

  echo "###################################################################"
  if [[ "$overall_status" -eq 0 ]]; then
    echo "All tests passed successfully."
    echo "###################################################################"
  else
    echo "One or more tests failed."
    exit 1
  fi
  echo "###################################################################"
}

function replace_templates() {
  case "$TEST_CASE" in
    "azure")
      if [[ -z "$AZURE_SUBSCRIPTION_ID" || -z "$AZURE_RESOURCE_GROUP" || -z "$USER_ASSIGNED_IDENTITY" ]]; then
        echo "Error: Missing Azure environment variables."
        exit 1
      fi
      ESCAPED_AZURE_SUBSCRIPTION_ID=$(printf '%s\n' "$AZURE_SUBSCRIPTION_ID" | sed 's/[&/\]/\\&/g')
      ESCAPED_AZURE_RESOURCE_GROUP=$(printf '%s\n' "$AZURE_RESOURCE_GROUP" | sed 's/[&/\]/\\&/g')
      ESCAPED_USER_ASSIGNED_IDENTITY=$(printf '%s\n' "$USER_ASSIGNED_IDENTITY" | sed 's/[&/\]/\\&/g')
      
      sed -e "s#{{ AZURE_SUBSCRIPTION_ID }}#$ESCAPED_AZURE_SUBSCRIPTION_ID#g" \
          -e "s#{{ AZURE_RESOURCE_GROUP }}#$ESCAPED_AZURE_RESOURCE_GROUP#g" \
          -e "s#{{ USER_ASSIGNED_IDENTITY }}#$ESCAPED_USER_ASSIGNED_IDENTITY#g" \
          "conf/policy/azure/authn-azure-hosts.template.yml" > "conf/policy/azure/authn-azure-hosts.yml"
      ;;
    "gcp")
      export GCP_TOKEN=$(cat gcp/token)
      GCP_PROJECT=$(cat gcp/project-id)
      ESCAPED_GCP_PROJECT=$(printf '%s\n' "$GCP_PROJECT" | sed 's/[&/\]/\\&/g')
      sed -e "s#{{ PROJECT_ID }}#$ESCAPED_GCP_PROJECT#g" \
          "conf/policy/gcp/authn-gcp-hosts.template.yml" > "conf/policy/gcp/authn-gcp-hosts.yml"
      ;;
  esac
}

function setup_test_dir {
  case "$TEST_CASE" in
    "jwt")
      test_dir="tests/jwt"
      ;;
    "api-key")
      test_dir="tests/api-key"
      # Resource tests currently only run on the API key scenario where the host is 
      # a member of the Authn_Admins group, plus re-running them would be redundant
      run_resource_tests=true      
      ;;
    "iam")
      test_dir="tests/iam"
      ;;
    "azure")
      test_dir="tests/azure"
      ;;
    "gcp")
      test_dir="tests/gcp"
      ;;
    *)
      echo "Error: Invalid test case '$TEST_CASE'"
      exit 1
      ;;
  esac
}

function rotate_host_api_key() {
  if [[ $TARGET == "cloud" ]]; then
    api_key=$(curl -k --request PUT --data "" \
      -H "Authorization: Token token=\"$INFRAPOOL_CONJUR_AUTHN_TOKEN\"" \
      $CONJUR_APPLIANCE_URL/authn/conjur/api_key?role=host:$(url_encode "data/testapp"))
  else
    api_key=$(client_exec conjur host rotate-api-key -i "data/testapp" | tr -d '\r')
  fi
}

function enable_authenticator() {
  service_id=$1
  if [[ $TARGET == "cloud" ]]; then
    curl -w "%{http_code}" -H "Authorization: Token token=\"$INFRAPOOL_CONJUR_AUTHN_TOKEN\"" \
        -X PATCH  -H 'Content-Type: text/plain' --data-raw 'enabled=true' "${CONJUR_APPLIANCE_URL}/$1/conjur"
  fi
}

function configure_jwt() {
  docker_compose up -d mock-jwt-server || true # Ignore error if already running
  export JWT_TOKEN=$(curl -s http://localhost:8080/token | jq -r .token)
  retries=5
  while [[ -z "$JWT_TOKEN" && $retries -gt 0 ]]; do
    echo "Waiting for JWT token to be generated..."
    sleep 2
    export JWT_TOKEN=$(curl -s http://localhost:8080/token | jq -r .token)
    retries=$((retries - 1))
  done

  # Output the token and stash it in a file
  echo "Received JWT Token: $JWT_TOKEN"
  echo $JWT_TOKEN > jwt_token
  
  echo $(curl -s http://localhost:8080/.well-known/jwks.json) > jwks.json

  docker_compose down mock-jwt-server
}

function deploy_conjur() {
  echo "> Launching local Conjur environment"
  echo ">> Pulling images (this may take a long time)"
  docker_compose pull -q
  echo ">> Starting Conjur"
  docker_compose up -d conjur-server
  echo ">> Creating account '$CONJUR_ACCOUNT'"
  if [[ "$TARGET" == "enterprise" ]]; then
    conjur_exec evoke configure master \
      --accept-eula \
      -h conjur-server \
      -p "$CONJUR_AUTHN_PASSWORD" \
      "$CONJUR_ACCOUNT"
  else
    conjur_exec $CONJUR_WAIT_COMMAND
    conjur_exec conjurctl account create "$CONJUR_ACCOUNT"
  fi
  echo ">> Waiting on conjur..."
  conjur_exec $CONJUR_WAIT_COMMAND
}

function configure_cli() {
  echo "> Configuring Conjur"

  if [[ "$TARGET" == "enterprise" ]]; then
    export CONJUR_SSL_CERTIFICATE=$(conjur_exec cat /opt/conjur/etc/ssl/conjur.pem)
  else
    export CONJUR_SSL_CERTIFICATE=$(< conf/https_config/ca.crt)
  fi

  if [[ "$TARGET" == "oss" ]]; then
    export CONJUR_AUTHN_API_KEY="$(conjur_exec conjurctl role retrieve-key "$CONJUR_ACCOUNT:user:admin" | tr -d '\r')"
    docker_compose up -d client
  elif [[ "$TARGET" == "enterprise" ]]; then
    docker_compose up -d client
    client_exec conjur login -i admin -p "$CONJUR_AUTHN_PASSWORD"
    export CONJUR_AUTHN_API_KEY="$(client_exec conjur user rotate-api-key)"
  fi

  client_exec conjur login -i admin -p "$CONJUR_AUTHN_API_KEY"
}

function load_policy() {
  branch=$1
  policy_file=$2

  if [[ $TARGET == "cloud" ]]; then
    curl -w "%{http_code}" -H "Authorization: Token token=\"$INFRAPOOL_CONJUR_AUTHN_TOKEN\"" \
      -X POST -d "$(cat $policy_file)" "${CONJUR_APPLIANCE_URL}/policies/conjur/policy/$branch"
  else 
    client_exec conjur policy load -b "$branch" -f "/$policy_file"
  fi
}

function set_variable() {
  variable_name=$1
  variable_value=$2

  if [[ $TARGET == "cloud" ]]; then
    curl -w "%{http_code}" -H "Authorization: Token token=\"$INFRAPOOL_CONJUR_AUTHN_TOKEN\"" \
      -X POST --data "${variable_value}" "${CONJUR_APPLIANCE_URL}/secrets/conjur/variable/$(url_encode "$variable_name")"
  else 
    client_exec conjur variable set -i "$variable_name" -v "$variable_value"
  fi
}


function load_test_policies() {
  policy_folder="conf/policy/$TEST_CASE"

  # If OSS/Enterprise, bootstrap empty data and authenticator branches to mirror Cloud
  if [[ "$TARGET" != "cloud" ]]; then
    load_policy "root" "conf/policy/common/authenticator_branches.yml"
  fi

  case "$TEST_CASE" in
    "api-key")
      load_policy "data" "$policy_folder/host.yml"
      load_policy "data" "$policy_folder/root.yml"
      set_variable "data/terraform/target-password" "$TEST_SECRET_VAL"
      ;;
    "iam")
      load_policy "conjur/authn-iam" "$policy_folder/authn-iam.yml"
      load_policy "data" "$policy_folder/authn-iam-host.yml"
      load_policy "conjur/authn-iam/prod" "$policy_folder/authn-permission.yml"
      set_variable "data/myspace/test-variable" "$TEST_SECRET_VAL"
      enable_authenticator "authn-iam/prod"
      ;;
    "azure")
      load_policy "conjur/authn-azure" "$policy_folder/authn-azure-AzureTerraform.yml"
      load_policy "data" "$policy_folder/authn-azure-hosts.yml"
      load_policy "data" "$policy_folder/authn-azure-secrets.yml"
      load_policy "conjur/authn-azure/AzureTerraform" "$policy_folder/authn-azure-permission.yml"
      set_variable "conjur/authn-azure/AzureTerraform/provider-uri" "https://sts.windows.net/df242c82-fe4a-47e0-b0f4-e3cb7f8104f1/"
      set_variable "data/terraform/target-password" "$TEST_SECRET_VAL"
      enable_authenticator "authn-azure/AzureTerraform"
      ;;
    "gcp")
      load_policy "conjur/authn-gcp" "$policy_folder/authn-gcp.yml"
      load_policy "data" "$policy_folder/authn-gcp-hosts.yml"
      load_policy "data" "$policy_folder/authn-gcp-secrets.yml"
      load_policy "conjur/authn-gcp" "$policy_folder/authn-gcp-permission.yml"
      set_variable "data/secrets/test-variable" "$TEST_SECRET_VAL"
      enable_authenticator "authn-gcp"
      ;;
    "jwt")
      configure_jwt
      load_policy "conjur/authn-jwt" "$policy_folder/authn-jwt.yml"
      load_policy "data" "$policy_folder/authn-host.yml"
      load_policy "data" "$policy_folder/app-secret.yml"
      load_policy "conjur/authn-jwt/my-service" "$policy_folder/authn-grant-app.yml"
      set_variable "conjur/authn-jwt/my-service/token-app-property" "username"
      set_variable "conjur/authn-jwt/my-service/identity-path" "data/my-service-apps"
      set_variable "conjur/authn-jwt/my-service/issuer" "mock-jwt-server"
      set_variable "conjur/authn-jwt/my-service/public-keys" "{\"type\":\"jwks\", \"value\":$(cat jwks.json)}"
      set_variable "data/Dev-Team-credential1" "$TEST_SECRET_VAL"
      enable_authenticator "authn-jwt/my-service"
      ;;
  esac
}

function run_terraform_tests() {
  target_dir=$1

  echo ">> Planning and applying '$target_dir/main.tf' Terraform manifest"

  export TF_LOG=DEBUG

  rm -f "$LOCAL_SECRET_FILE"

  docker_compose up -d terraform

  terraform_exec \
    "cd $target_dir/ &&
     rm -rf .terraform* 2>/dev/null &&
     rm -rf terraform* 2>/dev/null &&
     terraform init &&
     terraform plan &&
     terraform apply -auto-approve"

  docker compose rm --force \
    --stop \
    -v \
    terraform
}

function validate_results() {  
  [[ ! -f "$LOCAL_SECRET_FILE" || ! -s "$LOCAL_SECRET_FILE" ]] && { echo "Error: unable to retrieve the secrets"; return 1; }

  actual=$(< "$LOCAL_SECRET_FILE")
  rm -f "$LOCAL_SECRET_FILE"

  if [[ "$actual" == "$TEST_SECRET_VAL" ]]; then
    echo "Secret successfully retrieved!: $actual"
    return 0
  else
    echo "Secret mismatch: Expected '$TEST_SECRET_VAL', got '$actual'"
    return 1
  fi
}

function set_TF_vars() {
  export TF_VAR_conjur_appliance_url="$CONJUR_APPLIANCE_URL"
  export TF_VAR_conjur_account="$CONJUR_ACCOUNT"
  export TF_VAR_conjur_ssl_cert="$CONJUR_SSL_CERTIFICATE"
  
  # Set test-case specific variables
  case "$TEST_CASE" in
    "api-key")
      export TF_VAR_conjur_authn_type="api"
      export TF_VAR_conjur_secret_variable="data/terraform/target-password"
      export TF_VAR_conjur_authn_login="host/data/testapp"
      export TF_VAR_conjur_resource_owner_id="data/testapp"
      rotate_host_api_key
      export TF_VAR_conjur_api_key="$api_key"
      # NOTE: These are only used if configuring the provider with env vars instead of TF vars
      export CONJUR_AUTHN_LOGIN="host/data/testapp"
      export CONJUR_AUTHN_API_KEY="$api_key"
      ;;
    "jwt")
      export TF_VAR_conjur_authn_type="jwt"
      export TF_VAR_conjur_authn_service_id="my-service"
      export TF_VAR_conjur_secret_variable="data/Dev-Team-credential1"
      ;;
    "iam")
      export TF_VAR_conjur_authn_type="aws"
      export TF_VAR_conjur_host_id="host/data/myspace/601277729239/InstanceReadJenkinsExecutorHostFactoryToken"
      export TF_VAR_conjur_authn_service_id="prod"
      export TF_VAR_conjur_secret_variable="data/myspace/test-variable"
      ;;
    "azure")
      export TF_VAR_conjur_authn_type="azure"
      export TF_VAR_conjur_secret_variable="data/terraform/target-password"
      export TF_VAR_conjur_host_id="host/data/azure-apps/azureVM"
      export TF_VAR_conjur_authn_service_id="AzureTerraform"
      export TF_VAR_conjur_client_id="$USER_ASSIGNED_IDENTITY_CLIENT_ID"
      ;;
    "gcp")
      export TF_VAR_conjur_authn_type="gcp"
      export TF_VAR_conjur_authn_login="host/data/gcp-apps/test-app"
      export TF_VAR_conjur_secret_variable="data/secrets/test-variable"
      ;;
    *)
      echo "Unknown authentication type: $TEST_CASE"
      ;;
  esac
}

# Function to display help
function show_help() {
  echo "Usage: $0 -t <target> -tc <test_case> [-h]"
  echo ""
  echo "Options:"
  echo "  -t, --target         The target environment (oss, enterprise, cloud)."
  echo "  -tc, --test-case     The test case to run (api-key, iam, azure, gcp, jwt)."
  echo "  -h, --help           Show this help message."
  echo ""
  echo "Examples:"
  echo "  $0 -t oss -tc api-key    # Run 'oss' target with 'api-key' test."
  echo "  $0 -t enterprise -tc iam   # Run 'enterprise' target with 'iam' test."
}

# Parse command-line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--target)
      TARGET="$2"
      shift 2
      ;;
    -tc|--test-case)
      TEST_CASE="$2"
      shift 2
      ;;
    -jwt|--jwt-setup)
      JWT_SETUP="$2"
      shift 2
      ;;
    -h|--help)
      SHOW_HELP="true"
      shift
      ;;
    *)
      echo "Unknown option: $1"
      show_help
      exit 1
      ;;
  esac
done

# If --help flag is provided, show the help message
if [[ "$SHOW_HELP" == "true" ]]; then
  show_help
  exit 0
fi

# Ensure mandatory arguments are provided
if [[ -z "$TARGET" || -z "$TEST_CASE" ]]; then
  echo "Error: Both --target and --test-case are mandatory."
  show_help
  exit 1
fi

# Validate --target value
case "$TARGET" in
  "oss" | "enterprise" | "cloud")
    ;;
  *)
    echo "Error: Invalid target '$TARGET'. Valid options are 'oss', 'enterprise', or 'cloud'."
    exit 1
    ;;
esac

# Validate --test-case value
case "$TEST_CASE" in
  "api-key" | "iam" | "azure" | "gcp" | "jwt")
    ;;
  *)
    echo "Error: Invalid test case '$TEST_CASE'. Valid options are 'api-key', 'iam', 'azure', 'jwt', or 'gcp'."
    exit 1
    ;;
esac

main
