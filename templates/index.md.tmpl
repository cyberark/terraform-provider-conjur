# CyberArk Secrets Manager Provider

[![GitHub release](https://img.shields.io/github/release/cyberark/terraform-provider-conjur.svg)](https://github.com/cyberark/terraform-provider-conjur/releases/latest)

This provider manages authentication with CyberArk Secrets Manager, allowing Terraform to access and manage various Secrets Manager resources.

The provider can access the following Secrets Manager resources as data sources:
- [conjur_secret](./data-sources/secret.md)
- [conjur_certificate_issue](./data-sources/certificate_issue.md) (requires Secrets Manager Saas with Certificate Manager integration)
- [conjur_certificate_sign](./data-sources/certificate_sign.md) (requires Secrets Manager Saas with Certificate Manager integration)

The provider can also manage the following Secrets Manager resources:
- [conjur_authenticator](./resources/authenticator.md)
- [conjur_branch](./resources/branch.md)
- [conjur_host](./resources/host.md) (SaaS only)
- [conjur_group](./resources/group.md)
- [conjur_secret](./resources/secret.md) (SaaS only)
- [conjur_membership](./resources/membership.md)
- [conjur_permission](./resources/permission.md)

## Example Usage

### Using provider configuration attributes
{{ tffile "examples/provider/provider.tf" }}

### Using environment variables
Alternatively, the Terraform provider can read configuration from environment variables instead of provider attributes.
For example:
```sh
export CONJUR_APPLIANCE_URL="https://conjur-server"
export CONJUR_ACCOUNT="myorg"
export CONJUR_AUTHN_LOGIN="admin"
export CONJUR_AUTHN_API_KEY="3ahcddy39rcxzh3ggac4cwk3j2r8pqwdg33059y835ys2rh2kzs2a"
export CONJUR_CERT_FILE="/etc/conjur.pem"
```
In this scenario, the provider block can be left empty:
{{ tffile "examples/provider/provider_with_env_vars.tf" }}

{{ .SchemaMarkdown | trimspace }}

## Best Practices
When working with resources it is important to consider relationships which may affect the ability of the provider to manage many
resources simultaneously.  

Consider the following limitations:
- Nothing may be added to a branch before it is created or after it has been destroyed (error: `422 Unprocessable Entity`)
- Referenced role(s) and resource(s) must exist prior to applying memberships/permissions (error: `422 Unprocessable Entity`)
- Secrets Manager does not support simultaneous policy loading under the same branch (error: `409 Conflict`)

There are a few options to mitigate potential issues with concurrent resource management:  
- Use explicit dependencies to define resource creation order via `depends_on` attribute
    - For example, a conjur_group_membership resource depends on the conjur_host and conjur_group resources being created first
- Use implicit dependencies by referencing resource attributes
    - For example, reference a conjur_host and a conjur_group `name` attribute when creating a conjur_group_membership definition
- Use Terraform's concurrency control flag `-parallelism=1` flag when running `terraform` CLI commands
    - This ensures Terraform only makes one API call at a time. Note: there may still be issues with the order of requests with
      this method alone.
- If all else fails, simply re-running `terraform apply` multiple times can iteratively resolve issues as resources are created

## Alternate Workflow with Summon

If this Terraform provider does not fit your needs, you can also use
[summon](https://github.com/cyberark/summon) with the
[summon-conjur](https://github.com/cyberark/summon-conjur) provider
to provide secrets to Terraform via environment variables.
The user running `terraform` must already be authenticated with CyberArk Secrets Manager.

Terraform's [`TF_VAR_name` syntax](https://www.terraform.io/docs/configuration/environment-variables.html#tf_var_name)
allows a user to set Terraform variables via environment variables.
To use Terraform with Summon, prefix the environment variable names in secrets.yml with `TF_VAR_`.

### Example

```terraform
# variables.tf
variable "access_key" {}
variable "secret_key" {}
```

```yaml
# secrets.yml
TF_VAR_access_key: !var aws/dev/sys_powerful/access_key_id
TF_VAR_secret_key: !var aws/dev/sys_powerful/secret_access_key
```

Run Terraform with Summon:

```sh-session
$ summon terraform apply
```